# OpenEthereum SecretStore tests

This the fork of the reference implementation created for the master thesis ["Blockchain-based end-to-end encryption for Matrix instant messaging"](https://mirkozichichi.me/assets/tutor/theses/mscsparber.pdf) written by Julian Sparber.
This project uses the [Secret Store](https://openethereum.github.io/wiki/Secret-Store) feature of the [OpenEhtereum](https://openethereum.github.io/) Ethereum client in order to provide a testbed to evaluate a Secret Sharing algorithm in a blockchain network.

---

## Setup

To use this library an Ethereum network needs to be created. The script `network/start_ssh.sh` can be used to automatically create network on a set of remote computers.

You will need to build OpenEthereum yourself because the binary releases do not enable the SecretStore feature ([howto](https://openethereum.github.io/wiki/Secret-Store-Tutorial-1.html)).

Currently, all files have hardcoded values therefore please check before running any script that they contain correct usernames, paths, server addresses, etc.

---

### Secret Store

<!--
#### Local Network
Run the command `./start.sh -s [NUMBER_OF_NODES]` to create a network with a specific number of OpenEhtereum instances on the local machine. After deploying a smart contract the command `./start.sh -c [CONTRACT_ADDRESS]` can be used to set the permissioning contract for the Secret Store.
#### Remote Network
-->

- Within the `network` directory, run the command `./start_ssh.sh -s [NUMBER_OF_NODES]` to create a network with a specific number of OpenEhtereum instances on remote machines found in the file `nodes.txt` and runes all except on node on the remote computers.
- The first address found in `nodes.txt` must be the one of the node that is executing the code.
- The instances can be terminated by pressing `ctrl+c` once, also the fallback script `stop.sh` can be used to make sure that all nodes are completely terminated.
- After [deploying a SSPermissions smart contract to the network](https://openethereum.github.io/wiki/Secret-Store-Tutorial-4.html) (MetaMask recommended), the network can be stopped and then started again with the command `./start_ssh.sh -c [CONTRACT_ADDRESS]` to set the permissioning contract for the Secret Store.
- The crypto-module automatically deploys the smart contract `SSPermissions.sol` if the file `contract-address.txt` doesn't exist at the root of the project and it stores the address of the deployed contract in this file.

<!-- It may be needed to set the correct port forwarding at the router to make the local Ethereum node discoverable by the remote nodes -->.

### User's node

- Additionally to the network setup, a node with a user account has to be created to upload the Smart Contract (the config file `users.toml` can be used). This can be done by running `parity --config users.toml account new`
- This node will have two instances: one for the secret store (port 30301), and one for RPCs (port 30300). To execute the second instance and allow RPCs (publicly): (i) bootnodes from the file `test_network/ss1.toml` must be copied to `users.toml`; (ii) the address generated by the command `parity --config users.toml account new` must be assigned to the value `unlock` in `users.toml`; (iii) the following command will execute the second instance `parity --config users.toml`
- Before any tests can be run, they need to be updated with the correct account address and password, eventually, also the location for the Secret Store node and the user's node needs to be changed.

---

## Tests

To test the setup the command `cargo test setup1 -- --test-threads=1` can be used which does only check if the library can correctly access the Secret Store and the user's node and deploys automatically the smart contract if the file `contract-address.txt` is empty.

To run all tests just execute `cargo test -- --test-threads=1`. The source for tests can be found in the src/lib.rs file.
